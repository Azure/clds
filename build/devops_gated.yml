name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
  repositories:
  - repository: self
    clean: true
  - repository: c_build_tools
    type: github
    name: azure/c-build-tools
    endpoint: github.com_azure
    ref: refs/heads/master
jobs:
- template: /pipeline_templates/build_all_flavors.yml@c_build_tools
  parameters:
    cmake_options: '-Drun_repo_validation:BOOL=ON'
    GBALLOC_LL_TYPE_VALUES: ["PASSTHROUGH", "JEMALLOC"]
    ARCH_TYPE_VALUES: ["x64"]

- template: /pipeline_templates/run_master_check.yml@c_build_tools
  parameters:
    ignore_submodules: 'deps/mimalloc'

- template: /pipeline_templates/codeql3000_default.yml@c_build_tools
- job: windowsperf
  displayName: 'Build Windows Perf tests (RelWithDebInfo x64, custom script)'
  pool:
    name: Azure-MessagingStore-WinBuildPoolVS2022_0
    demands:
    - Build
    - Cmd
    - msbuild
    - visualstudio

  steps:
  - task: BatchScript@1
    displayName: 'Git submodule update'
    inputs:
      filename: 'C:\Program Files\Git\bin\git.exe'
      arguments: 'submodule update --init --force'

  - task: BatchScript@1
    displayName: 'Git submodule clean'
    inputs:
      filename: 'C:\Program Files\Git\bin\git.exe'
      arguments: 'submodule foreach --recursive "git clean -xdf"'

  - task: BatchScript@1
    displayName: 'Git clean'
    inputs:
      filename: 'C:\Program Files\Git\bin\git.exe'
      arguments: 'clean -xdf'

  - task: BatchScript@1
    displayName: 'Setup VS Vars'
    inputs:
      filename: '"c:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"'
      modifyEnvironment: true

  - task: CMake@1
    displayName: CMake
    inputs:
      workingDirectory: 'build_x64'
      cmakeArgs: '.. -Drun_perf_tests:bool=ON -Drun_traceability:bool=OFF -G "Visual Studio 17 2022"  -DCMAKE_BUILD_TYPE=RelWithDebInfo -Ax64'

  - task: VSBuild@1
    displayName: 'Build solution build_x64\*.sln'
    inputs:
      solution: 'build_x64\*.sln'
      platform: x64
      msbuildArgs: '/t:restore /t:build'
      configuration: RelWithDebInfo
      maximumCpuCount: true

  - script: |
     echo Running Hash table perf test
     $(Build.Repository.LocalPath)/build_x64/RelWithDebInfo/clds_hash_table_perf.exe

    workingDirectory: 'build_x64'
    displayName: 'Run clds_hash_table_perf tests'

  - script: |
     echo Running Singly linked list perf test
     $(Build.Repository.LocalPath)/build_x64/RelWithDebInfo/clds_singly_linked_list_perf.exe

    workingDirectory: 'build_x64'
    displayName: 'Run clds_singly_linked_list_perf tests'

  - script: |
     echo Running Sorted list perf test
     $(Build.Repository.LocalPath)/build_x64/RelWithDebInfo/clds_sorted_list_perf.exe

    workingDirectory: 'build_x64'
    displayName: 'Run clds_sorted_list_perf tests'

  - script: |
     echo Running Lock free set perf test
     $(Build.Repository.LocalPath)/build_x64/RelWithDebInfo/lock_free_set_perf.exe

    workingDirectory: 'build_x64'
    displayName: 'Run lock_free_set_perf tests'

  - task: CmdLine@2
    displayName: 'Run ctest tests - Perf'
    inputs:
      script: 'ctest -C "RelWithDebInfo" -V --output-on-failure -R perf'
      workingDirectory: 'build_x64'

  - template : /pipeline_templates/clean_ado_folders.yml@c_build_tools

- template: /pipeline_templates/build_linux.yml@c_build_tools
  parameters:
    cmake_options: '-Drun_valgrind:BOOL=ON -Drun_helgrind:BOOL=ON -Drun_drd:BOOL=OFF -Drun_unittests:BOOL=ON -Drun_int_tests:BOOL=ON -DCMAKE_BUILD_TYPE=Debug'
    ctest_exclude_regex: 'clds_sorted_list_int_valgrind|clds_sorted_list_int_helgrind'
